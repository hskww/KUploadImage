<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title></title>
		<style>
			.kup input[type=file]{display: none;}
			.kup label{display: block;}
			.kup form{display: none;}
			.imgpre img{max-width:120px; max-height: 100px;}
			.imgpre .del{position: absolute;height: 20px;width:20px; float: right; color:#fff; border:1px solid #ccc; text-align: center;font-style: normal; }
		</style>
	</head>
	<body>
		
		<div class="kup" id="KUploadImage"> 
			<input id="fileinput" name="files" type="file" multiple="multiple" value="" />
			<label for="fileinput">选择文件</label>
			
		</div>
		
		<div id="outer" class="imgpre">
			
		</div>
		<button id="submit">提交</button>
<script type="text/javascript">
/*
 * KUploadImage基于html5，用原生JS实现的异步图片上传
 * 使用方法KUploadImage.init(param)
 * @params
 * 	url:"/File/upload",//上传路径，字符串，必需
	fileinput:fileinput,//上传文件元素,必需
	outerDom:outer,//展现图片容器，必需
	filterfile:function(file){},// 返回ture 滤除此文件，返回false 保留此文件，可选
	beforeupload:function(){},//上传之前回调 可选
	completeupload:function(){}//完成上传回调 可选
 * 
 **/

(function(win){
	var KUploadImage={};
	var kup=KUploadImage;
	KUploadImage.version="1.0.0";
	KUploadImage.addFile=function(files){
		if(files.length>0){
			for(var i=0;i<files.length; i++){
				var file=files[i];
				var sf={
					name:file.name,
					size:file.size,
					type:file.type
				}
				if(kup.checkfile){
					if(kup.filterfile(file)){
						continue;
					}
				}
				sf.index=kup.selectFileIndex;
				kup.selectFile.push(sf);
				var reader=new FileReader();
				reader.onload = function(e) {
					var imgdiv = document.createElement("span");
					imgdiv.setAttribute("index",1);
					var i=document.createElement("i");
					i.innerHTML="X";
					i.className="del";
					imgdiv.appendChild(i);
				    var img = new Image();
				    img.src = reader.result;
				    imgdiv.appendChild(img);
				   	kup.outerDom.appendChild(imgdiv);
				   	kup.selectFileIndex++;
				 }
			  	reader.readAsDataURL(file);
			}
			
		}
	}
	var sucesscount=0,failedcount=0;
	var ajax=function(postdata,binary){
		var query="";
		for(var i in postdata){
			query += i+"="+postdata[i]+"&";
		}
		var url=kup.url+"?"+encodeURIComponent(query);
		var type="POST";
		var async=false;
		var xmlhttp=new XMLHttpRequest();
		xmlhttp.setRequestHeader('Content-Type', "multipart/form-data");
		xmlhttp.onreadystatechange=function(){
		 if (xmlhttp.readyState==4){
		 	kup.selectFileIndex--;
		 	if(xmlhttp.status==200){
		 		sucesscount++;
		    	if(kup.selectFileIndex == 0){
		    	console.log("成功上传 " + sucesscount + " 个，失败"+failedcount+"个");
		    		kup.completeupload();
		    	}
		 	}else{
		 		failedcount--;
		  	 	console.log("错误 " + xmlhttp.status + " 上传文件发现错误,文件名"+postdata.name);
		 	}
		 }
		
		}
		xmlhttp.open(type,url,async);
		xmlhttp.send(binary);
	}
	KUploadImage.UploadFile=function(){
		kup.beforeupload();
		var imgs = kup.outerDom.getElementsByTagName("img");
		var l = imgs.length;
		for(var i=0; i<l; i++){
			var postdata={
				name: kup.selectFile[i].name,
				size:kup.selectFile[i].size,
				type:kup.selectFile[i].type
			}
			var reader=new FileReader();
			reader.onload = function(e) {
				ajax(postdata,reader.result);
			}
		  	reader.readAsBinaryString(imgs[i].src);
		}
	}
	
	KUploadImage.init=function(param){
		
		kup.fileinput=param.fileinput;
		kup.outerDom=param.outerDom;
		kup.url=param.url;
		kup.complete=param.complete||function(){};
		kup.beforsend=param.beforsend||function(){};
		kup.selectimg=param.selectimg||function(){};
		kup.selectFile=[];
		kup.selectFileIndex=0;
		kup.fileinput.addEventListener("change",function(e){
			kup.addFile(this.files);
		});
		kup.outerDom.addEventListener("click",function(e){
			if(e.target.className.indexOf("del")>-1){
				var imgdiv = e.target.parentNode;
				imgdiv.parentNode.removeChild(imgdiv);
				kup.selectFileIndex--;
			}
		});
	}
	window.KUploadImage=KUploadImage;
}(window));
</script>
<script>
	var fileinput=document.getElementById("fileinput");
	var outer=document.getElementById("outer");
	KUploadImage.init({
		url:"Group/uploadPicture",
		fileinput:fileinput,
		outerDom:outer,
		filterfile:function(file){
			//返回ture 滤除此文件，返回false 保留此文件
			var isfind=true;
			for(var j=0; j<KUploadImage.selectFile.length; j++ ){
				if(file.name == KUploadImage.selectFile[j].name){
					isfind=true;
					break;
				}
			}
			return isfind;
		},
		beforeupload:function(){
			
		},
		completeupload:function(){
			
		}
	});
</script>
	</body>
</html>
